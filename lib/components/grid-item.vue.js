"use strict";const r=require("vue"),l=require("@vexip-ui/utils"),y=require("../helpers/common.js"),C=require("../helpers/draggable.js"),He=require("../helpers/responsive.js"),he=require("../helpers/dom.js"),Me=require("moveable"),Ne=r.defineComponent({__name:"grid-item",props:{isDraggable:{type:Boolean,default:null},isResizable:{type:Boolean,default:null},isBounded:{type:Boolean,default:null},static:{type:Boolean,default:!1},minH:{type:Number,default:1},minW:{type:Number,default:1},maxH:{type:Number,default:1/0},maxW:{type:Number,default:1/0},x:{type:Number,required:!0},y:{type:Number,required:!0},w:{type:Number,required:!0},h:{type:Number,required:!0},i:{type:[Number,String],required:!0}},emits:["container-resized","resize","resized","move","moved"],setup(me,{expose:pe,emit:M}){const i=me,o=r.inject(y.LAYOUT_KEY),u=r.inject(y.EMITTER_KEY);if(!o)throw new Error("[grid-layout-plus]: missing layout store, GridItem must under a GridLayout.");const h=r.ref(null),e=r.reactive({cols:1,containerWidth:100,rowHeight:30,margin:[10,10],maxRows:1/0,draggable:null,resizable:null,bounded:null,transformScale:1,useCssTransforms:!0,useStyleCursor:!0,isDragging:!1,dragging:{top:-1,left:-1},isResizing:!1,resizing:{width:-1,height:-1},style:{},rtl:!1});let X=!1,_=!1,A=NaN,j=NaN,G=NaN,F=NaN,K=-1,$=-1,V=-1,J=-1,p=i.x,v=i.y,w=i.w,x=i.h;const N=r.ref(),Q=r.reactive({i:r.toRef(i,"i"),state:e,wrapper:N,calcXY:I});function Z(t){Re(t)}function U(){ue()}function ee(t){l.isNull(i.isDraggable)&&(e.draggable=t)}function te(t){l.isNull(i.isResizable)&&(e.resizable=t)}function ie(t){l.isNull(i.isBounded)&&(e.bounded=t)}function ne(t){e.transformScale=t}function re(t){e.rowHeight=t}function ae(t){e.maxRows=t}function se(){e.rtl=he.getDocumentDir()==="rtl",ue()}function oe(t){e.cols=Math.floor(t)}o.increaseItem(Q),r.onBeforeMount(()=>{e.rtl=he.getDocumentDir()==="rtl"}),r.onMounted(()=>{o.responsive&&o.lastBreakpoint?e.cols=He.getColsFromBreakpoint(o.lastBreakpoint,o.cols):e.cols=o.colNum,e.rowHeight=o.rowHeight,e.containerWidth=o.width!==null?o.width:100,e.margin=o.margin!==void 0?o.margin.map(Number):[10,10],e.maxRows=o.maxRows,l.isNull(i.isDraggable)?e.draggable=o.isDraggable:e.draggable=i.isDraggable,l.isNull(i.isResizable)?e.resizable=o.isResizable:e.resizable=i.isResizable,l.isNull(i.isBounded)?e.bounded=o.isBounded:e.bounded=i.isBounded,e.transformScale=o.transformScale,e.useCssTransforms=o.useCssTransforms,e.useStyleCursor=o.useStyleCursor,r.watchEffect(()=>{p=i.x,v=i.y,x=i.h,w=i.w,l.nextTickOnce(S)}),u.on("updateWidth",Z),u.on("compact",U),u.on("setDraggable",ee),u.on("setResizable",te),u.on("setBounded",ie),u.on("setTransformScale",ne),u.on("setRowHeight",re),u.on("setMaxRows",ae),u.on("directionchange",se),u.on("setColNum",oe)}),r.onBeforeUnmount(()=>{u.off("updateWidth",Z),u.off("compact",U),u.off("setDraggable",ee),u.off("setResizable",te),u.off("setBounded",ie),u.off("setTransformScale",ne),u.off("setRowHeight",re),u.off("setMaxRows",ae),u.off("directionchange",se),u.off("setColNum",oe),h.value&&h.value.destroy(),o.decreaseItem(Q)}),pe({state:e,wrapper:N});const we=navigator.userAgent.toLowerCase().includes("android"),le=r.computed(()=>e.resizable&&!i.static),m=r.computed(()=>o.isMirrored?!e.rtl:e.rtl),be=r.computed(()=>(e.draggable||e.resizable)&&!i.static),z=y.useNameHelper("item"),ze=r.computed(()=>({[z.b()]:!0,[z.bm("resizable")]:le.value,[z.bm("static")]:i.static,[z.bm("resizing")]:e.isResizing,[z.bm("dragging")]:e.isDragging,[z.bm("transform")]:e.useCssTransforms,[z.bm("rtl")]:m.value,[z.bm("no-touch")]:we&&be.value})),ve=r.computed(()=>[z.be("resizer"),m.value&&z.bem("resizer","rtl")].filter(Boolean));r.watch(()=>i.isDraggable,t=>{e.draggable=t}),r.watch(()=>i.static,()=>{l.nextTickOnce(de),l.nextTickOnce(H)}),r.watch(()=>e.draggable,()=>{l.nextTickOnce(de)}),r.watch(()=>i.isResizable,t=>{e.resizable=t}),r.watch(()=>i.isBounded,t=>{e.bounded=t}),r.watch(()=>e.resizable,()=>{l.nextTickOnce(H)}),r.watch(()=>e.rowHeight,()=>{l.nextTickOnce(S),l.nextTickOnce(W)}),r.watch([()=>e.cols,()=>e.containerWidth],()=>{l.nextTickOnce(H),l.nextTickOnce(S),l.nextTickOnce(W)}),r.watch([()=>i.minH,()=>i.maxH,()=>i.minW,()=>i.maxW],()=>{l.nextTickOnce(H)}),r.watch(m,()=>{l.nextTickOnce(H),l.nextTickOnce(S)}),r.watch([()=>o.margin,()=>o.margin[0],()=>o.margin[1]],()=>{const t=o.margin;!t||t[0]===e.margin[0]&&t[1]===e.margin[1]||(e.margin=t.map(Number),l.nextTickOnce(S),l.nextTickOnce(W))});function S(){i.x+i.w>e.cols?(p=0,w=i.w>e.cols?e.cols:i.w):(p=i.x,w=i.w);const t=E(p,v,w,x);e.isDragging&&(t.top=e.dragging.top,m.value?t.right=e.dragging.left:t.left=e.dragging.left),e.isResizing&&(t.width=e.resizing.width,t.height=e.resizing.height);let a;e.useCssTransforms?m.value?a=y.setTransformRtl(t.top,t.right,t.width,t.height):a=y.setTransform(t.top,t.left,t.width,t.height):m.value?a=y.setTopRight(t.top,t.right,t.width,t.height):a=y.setTopLeft(t.top,t.left,t.width,t.height),e.style=a}function W(){const t={};for(const a of["width","height"]){const g=e.style[a].match(/^(\d+)px$/);if(!g)return;t[a]=g[1]}M("container-resized",i.i,i.h,i.w,t.height,t.width)}function D(t,a){if(i.static||a==="resizestart"&&e.isResizing||a!=="resizestart"&&!e.isResizing)return;const c=C.getControlPosition(t);if(l.isNull(c))return;const{x:g,y:f}=c,s={width:0,height:0};let n;switch(a){case"resizestart":{H(),K=w,$=x,n=E(p,v,w,x),s.width=n.width,s.height=n.height,e.resizing=s,e.isResizing=!0;break}case"resizemove":{const d=C.createCoreData(G,F,g,f);m.value?s.width=e.resizing.width-d.deltaX/e.transformScale:s.width=e.resizing.width+d.deltaX/e.transformScale,s.height=e.resizing.height+d.deltaY/e.transformScale,e.resizing=s;break}case"resizeend":{n=E(p,v,w,x),s.width=n.width,s.height=n.height,e.resizing={width:-1,height:-1},e.isResizing=!1;break}}n=xe(s.height,s.width),n.w<i.minW&&(n.w=i.minW),n.w>i.maxW&&(n.w=i.maxW),n.h<i.minH&&(n.h=i.minH),n.h>i.maxH&&(n.h=i.maxH),n.h<1&&(n.h=1),n.w<1&&(n.w=1),G=g,F=f,(w!==n.w||x!==n.h)&&M("resize",i.i,n.h,n.w,s.height,s.width),a==="resizeend"&&(K!==w||$!==x)&&M("resized",i.i,n.h,n.w,s.height,s.width),u.emit("resizeEvent",a,i.i,p,v,n.h,n.w)}function O(t,a){if(i.static||e.isResizing||a==="dragstart"&&e.isDragging||a!=="dragstart"&&!e.isDragging)return;const c=C.getControlPosition(t);if(l.isNull(c))return;const{x:g,y:f}=c,s=t.target;if(!s.offsetParent)return;const n={top:0,left:0};switch(a){case"dragstart":{V=p,J=v;const b=s.offsetParent.getBoundingClientRect(),R=s.getBoundingClientRect(),T=R.left/e.transformScale,k=b.left/e.transformScale,q=R.right/e.transformScale,P=b.right/e.transformScale,L=R.top/e.transformScale,Y=b.top/e.transformScale;m.value?n.left=(q-P)*-1:n.left=T-k,n.top=L-Y,e.dragging=n,e.isDragging=!0;break}case"dragmove":{const b=C.createCoreData(A,j,g,f);if(m.value?n.left=e.dragging.left-b.deltaX/e.transformScale:n.left=e.dragging.left+b.deltaX/e.transformScale,n.top=e.dragging.top+b.deltaY/e.transformScale,e.bounded){const R=s.offsetParent.clientHeight-ce(i.h,e.rowHeight,e.margin[1]);n.top=ge(n.top,0,R);const T=B(),k=e.containerWidth-ce(i.w,T,e.margin[0]);n.left=ge(n.left,0,k)}e.dragging=n;break}case"dragend":{const b=s.offsetParent.getBoundingClientRect(),R=s.getBoundingClientRect(),T=R.left/e.transformScale,k=b.left/e.transformScale,q=R.right/e.transformScale,P=b.right/e.transformScale,L=R.top/e.transformScale,Y=b.top/e.transformScale;m.value?n.left=(q-P)*-1:n.left=T-k,n.top=L-Y,e.dragging={top:-1,left:-1},e.isDragging=!1;break}}let d;m.value,d=I(n.top,n.left),A=g,j=f,(p!==d.x||v!==d.y)&&M("move",i.i,d.x,d.y),a==="dragend"&&(V!==p||J!==v)&&M("moved",i.i,d.x,d.y),u.emit("dragEvent",a,i.i,d.x,d.y,x,w)}function E(t,a,c,g){const f=B();let s;return m.value?s={right:Math.round(f*t+(t+1)*e.margin[0]),top:Math.round(e.rowHeight*a+(a+1)*e.margin[1]),width:c===1/0?c:Math.round(f*c+Math.max(0,c-1)*e.margin[0]),height:g===1/0?g:Math.round(e.rowHeight*g+Math.max(0,g-1)*e.margin[1])}:s={left:Math.round(f*t+(t+1)*e.margin[0]),top:Math.round(e.rowHeight*a+(a+1)*e.margin[1]),width:c===1/0?c:Math.round(f*c+Math.max(0,c-1)*e.margin[0]),height:g===1/0?g:Math.round(e.rowHeight*g+Math.max(0,g-1)*e.margin[1])},s}function I(t,a){const c=B();let g=Math.round((a-e.margin[0])/(c+e.margin[0])),f=Math.round((t-e.margin[1])/(e.rowHeight+e.margin[1]));return g=Math.max(Math.min(g,e.cols-w),0),f=Math.max(Math.min(f,e.maxRows-x),0),{x:g,y:f}}function B(){return(e.containerWidth-e.margin[0]*(e.cols+1))/e.cols}function ce(t,a,c){return Number.isFinite(t)?Math.round(a*t+Math.max(0,t-1)*c):t}function ge(t,a,c){return Math.max(Math.min(t,c),a)}function xe(t,a,c=!1){const g=B();let f=Math.round((a+e.margin[0])/(g+e.margin[0])),s=0;return c?s=Math.ceil((t+e.margin[1])/(e.rowHeight+e.margin[1])):s=Math.round((t+e.margin[1])/(e.rowHeight+e.margin[1])),f=Math.max(Math.min(f,e.cols-p),0),s=Math.max(Math.min(s,e.maxRows-v),0),{w:f,h:s}}function Re(t,a){e.containerWidth=t,a!=null&&(e.cols=a)}function ue(){S()}function fe(){!h.value&&N.value&&(h.value=new Me(document.body,{target:N.value,hideDefaultLines:!0,origin:!1}))}const ye=l.throttle(O);function de(){fe(),h.value&&(e.draggable&&!i.static?(h.value.setState({draggable:!0}),X||(X=!0,h.value.on("dragStart",t=>O(t,"dragstart")).on("drag",t=>ye(t,"dragmove")).on("dragEnd",t=>O(t,"dragend")))):h.value.setState({draggable:!1}))}const Se=l.throttle(D);function H(){fe(),h.value&&(e.resizable&&!i.static?(h.value.setState({resizable:!0}),_||(_=!0,h.value.on("resizeStart",t=>D(t,"resizestart")).on("resize",t=>Se(t,"resizemove")).on("resizeEnd",t=>D(t,"resizeend")))):h.value.setState({resizable:!1}))}return(t,a)=>(r.openBlock(),r.createElementBlock("section",{ref_key:"wrapper",ref:N,class:r.normalizeClass(r.unref(ze)),style:r.normalizeStyle(e.style)},[r.renderSlot(t.$slots,"default"),r.unref(le)?(r.openBlock(),r.createElementBlock("span",{key:0,class:r.normalizeClass(r.unref(ve))},null,2)):r.createCommentVNode("",!0)],6))}});module.exports=Ne;
//# sourceMappingURL=grid-item.vue.js.map
